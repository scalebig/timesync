(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.timesync=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=emitter;function emitter(obj){var _callbacks={};obj.emit=function(event,data){var callbacks=_callbacks[event];callbacks&&callbacks.forEach(function(callback){return callback(data)})};obj.on=function(event,callback){var callbacks=_callbacks[event]||(_callbacks[event]=[]);callbacks.push(callback);return obj};obj.off=function(event,callback){if(callback){var callbacks=_callbacks[event];var index=callbacks.indexOf(callback);if(index!==-1){callbacks.splice(index,1)}if(callbacks.length===0){delete _callbacks[event]}}else{delete _callbacks[event]}return obj};obj.list=function(event){return _callbacks[event]||[]};return obj}},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.fetch=fetch;exports.post=post;function fetch(method,url,body,headers,callback,timeout){try{var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState==4){var contentType=xhr.getResponseHeader("Content-Type");if(contentType&&contentType.indexOf("json")!==-1){try{var response=JSON.parse(xhr.responseText);callback(null,response,xhr.status)}catch(err){callback(err,null,xhr.status)}}else{callback(null,xhr.responseText,xhr.status)}}};if(headers){for(var name in headers){if(headers.hasOwnProperty(name)){xhr.setRequestHeader(name,headers[name])}}}xhr.ontimeout=function(err){callback(err,null,0)};xhr.open(method,url,true);xhr.timeout=timeout;if(typeof body==="string"){xhr.send(body)}else if(body){xhr.setRequestHeader("Content-Type","application/json");xhr.send(JSON.stringify(body))}else{xhr.send()}}catch(err){callback(err,null,0)}}function post(url,body,timeout){return new Promise(function(resolve,reject){var callback=function callback(err,res,status){if(err){return reject(err)}resolve([res,status])};fetch("POST",url,body,null,callback,timeout)})}},{}],3:[function(require,module,exports){"use strict";var isBrowser=typeof window!=="undefined";module.exports=isBrowser?require("./request.browser"):require("./request.node")},{"./request.browser":2,"./request.node":4}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.post=post;var _http=require("http");var _http2=_interopRequireDefault(_http);var _https=require("https");var _https2=_interopRequireDefault(_https);var _url=require("url");var _url2=_interopRequireDefault(_url);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var parseUrl=_url2.default.parse;function post(url,body,timeout){return new Promise(function(resolve,reject){var data=body==="string"?body:JSON.stringify(body);var urlObj=parseUrl(url);var options={host:urlObj.hostname,port:urlObj.port,path:urlObj.path,method:"POST",headers:{"Content-Length":data.length}};if(body!=="string"){options.headers["Content-Type"]="application/json"}var proto=urlObj.protocol==="https:"?_https2.default:_http2.default;var req=proto.request(options,function(res){res.setEncoding("utf8");var result="";res.on("data",function(data){result+=data});res.on("end",function(){var contentType=res.headers["content-type"];var isJSON=contentType&&contentType.indexOf("json")!==-1;try{var body=isJSON?JSON.parse(result):result;resolve([body,res.statusCode])}catch(err){reject(err)}})});req.on("error",reject);req.on("socket",function(socket){socket.setTimeout(timeout,function(){req.abort()})});req.write(data);req.end()})}},{http:undefined,https:undefined,url:undefined}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.compare=compare;exports.add=add;exports.sum=sum;exports.mean=mean;exports.std=std;exports.variance=variance;exports.median=median;function compare(a,b){return a>b?1:a<b?-1:0}function add(a,b){return a+b}function sum(arr){return arr.reduce(add)}function mean(arr){return sum(arr)/arr.length}function std(arr){return Math.sqrt(variance(arr))}function variance(arr){if(arr.length<2)return 0;var _mean=mean(arr);return arr.map(function(x){return Math.pow(x-_mean,2)}).reduce(add)/(arr.length-1)}function median(arr){if(arr.length<2)return arr[0];var sorted=arr.slice().sort(compare);if(sorted.length%2===0){return(sorted[arr.length/2-1]+sorted[arr.length/2])/2}else{return sorted[(arr.length-1)/2]}}},{}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.create=create;var _util=require("./util.js");var util=_interopRequireWildcard(_util);var _stat=require("./stat.js");var stat=_interopRequireWildcard(_stat);var _request=require("./request/request");var request=_interopRequireWildcard(_request);var _emitter=require("./emitter.js");var _emitter2=_interopRequireDefault(_emitter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function create(options){var timesync={options:{interval:60*60*1e3,timeout:1e4,delay:1e3,repeat:5,peers:[],server:null,now:Date.now},offset:0,_timeout:null,_inProgress:{},_isFirst:true,send:function send(to,data,timeout){return request.post(to,data,timeout).then(function(val){var res=val[0];timesync.receive(to,res)}).catch(function(err){emitError(err)})},receive:function receive(from,data){if(data===undefined){data=from;from=undefined}if(data&&data.id in timesync._inProgress){timesync._inProgress[data.id](data.result)}else if(data&&data.id!==undefined){timesync.send(from,{jsonrpc:"2.0",id:data.id,result:timesync.now()})}},_handleRPCSendError:function _handleRPCSendError(id,reject,err){delete timesync._inProgress[id];reject(new Error("Send failure"))},rpc:function rpc(to,method,params){var id=util.nextId();var resolve,reject;var deferred=new Promise(function(res,rej){resolve=res;reject=rej});timesync._inProgress[id]=function(data){delete timesync._inProgress[id];resolve(data)};var sendResult=void 0;try{sendResult=timesync.send(to,{jsonrpc:"2.0",id:id,method:method,params:params},timesync.options.timeout)}catch(err){timesync._handleRPCSendError(id,reject,err)}if(sendResult&&(sendResult instanceof Promise||sendResult.then&&sendResult.catch)){sendResult.catch(timesync._handleRPCSendError.bind(this,id,reject))}else{console.warn("Send should return a promise")}return deferred},sync:function sync(){timesync.emit("sync","start");var peers=timesync.options.server?[timesync.options.server]:timesync.options.peers;return Promise.all(peers.map(function(peer){return timesync._syncWithPeer(peer)})).then(function(all){var offsets=all.filter(function(offset){return timesync._validOffset(offset)});if(offsets.length>0){timesync.offset=stat.mean(offsets);timesync.emit("change",timesync.offset)}timesync.emit("sync","end")})},_validOffset:function _validOffset(offset){return offset!==null&&!isNaN(offset)&&isFinite(offset)},_syncWithPeer:function _syncWithPeer(peer){var all=[];function sync(){return timesync._getOffset(peer).then(function(result){return all.push(result)})}function waitAndSync(){return util.wait(timesync.options.delay).then(sync)}function notDone(){return all.length<timesync.options.repeat}return sync().then(function(){return util.whilst(notDone,waitAndSync)}).then(function(){var results=all.filter(function(result){return result!==null});var roundtrips=results.map(function(result){return result.roundtrip});var limit=stat.median(roundtrips)+stat.std(roundtrips);var filtered=results.filter(function(result){return result.roundtrip<limit});var offsets=filtered.map(function(result){return result.offset});return offsets.length>0?stat.mean(offsets):null})},_getOffset:function _getOffset(peer){var start=timesync.options.now();return timesync.rpc(peer,"timesync").then(function(timestamp){var end=timesync.options.now();var roundtrip=end-start;var offset=timestamp-end+roundtrip/2;if(timesync._isFirst){timesync._isFirst=false;timesync.offset=offset;timesync.emit("change",offset)}return{roundtrip:roundtrip,offset:offset}}).catch(function(err){return null})},now:function now(){return timesync.options.now()+timesync.offset},destroy:function destroy(){clearTimeout(timesync._timeout)}};if(options){if(options.server&&options.peers){throw new Error('Configure either option "peers" or "server", not both.')}for(var prop in options){if(options.hasOwnProperty(prop)){if(prop==="peers"&&typeof options.peers==="string"){timesync.options.peers=options.peers.split(",").map(function(peer){return peer.trim()}).filter(function(peer){return peer!==""})}else{timesync.options[prop]=options[prop]}}}}(0,_emitter2.default)(timesync);function emitError(err){if(timesync.list("error").length>0){timesync.emit("error",err)}else{console.log("Error",err)}}if(timesync.options.interval!==null){timesync._timeout=setInterval(timesync.sync,timesync.options.interval);setTimeout(function(){timesync.sync().catch(function(err){return emitError(err)})},0)}return timesync}},{"./emitter.js":1,"./request/request":3,"./stat.js":5,"./util.js":7}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.wait=wait;exports.repeat=repeat;exports.whilst=whilst;exports.nextId=nextId;function wait(delay){return new Promise(function(resolve){setTimeout(resolve,delay)})}function repeat(fn,times){return new Promise(function(resolve,reject){var count=0;var results=[];function recurse(){if(count<times){count++;fn().then(function(result){results.push(result);recurse()})}else{resolve(results)}}recurse()})}function whilst(condition,callback){return new Promise(function(resolve,reject){function recurse(){if(condition()){callback().then(function(){return recurse()})}else{resolve()}}recurse()})}function nextId(){return _id++}var _id=0},{}]},{},[6])(6)});